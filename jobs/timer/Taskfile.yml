# Timer Microservice Tasks

version: '3'

vars:
  SERVICE_NAME: timer-service
  IMAGE_TAG: '{{.IMAGE_TAG | default "latest"}}'
  REGISTRY: '{{.REGISTRY | default "your-registry"}}'

tasks:
  # Build tasks
  build:
    desc: "Build timer service"
    cmds:
      - cargo build

  build:release:
    desc: "Build timer service (release)"
    cmds:
      - cargo build --release

  # Test tasks
  test:
    desc: "Run timer tests"
    cmds:
      - cargo test

  test:integration:
    desc: "Run integration tests"
    cmds:
      - cargo test --test integration

  # Code quality
  fmt:
    desc: "Format timer code"
    cmds:
      - cargo fmt

  clippy:
    desc: "Run clippy on timer"
    cmds:
      - cargo clippy -- -D warnings

  check:
    desc: "Check timer (fmt + clippy + test)"
    cmds:
      - task: fmt
      - task: clippy
      - task: test

  # Development
  run:
    desc: "Run timer service locally"
    env:
      TIMER_DURATION_SECONDS: '{{.TIMER_DURATION_SECONDS | default "300"}}'
      CONTROL_PLANE_ENDPOINT: '{{.CONTROL_PLANE_ENDPOINT | default "http://localhost:50053"}}'
      RUST_LOG: '{{.RUST_LOG | default "info"}}'
      TIMER_NAME: '{{.TIMER_NAME | default "dev-timer"}}'
    cmds:
      - cargo run

  run:debug:
    desc: "Run timer service with debug logging"
    env:
      TIMER_DURATION_SECONDS: '{{.TIMER_DURATION_SECONDS | default "60"}}'
      CONTROL_PLANE_ENDPOINT: '{{.CONTROL_PLANE_ENDPOINT | default "http://localhost:50053"}}'
      RUST_LOG: debug
      TIMER_NAME: debug-timer
    cmds:
      - cargo run

  watch:
    desc: "Watch and rebuild timer"
    cmds:
      - cargo watch -x build

  watch:test:
    desc: "Watch and test timer"
    cmds:
      - cargo watch -x test

  # Container tasks
  container:build:
    desc: "Build timer container image"
    cmds:
      - podman build -t {{.SERVICE_NAME}}:{{.IMAGE_TAG}} .

  container:run:
    desc: "Run timer in Podman"
    env:
      TIMER_DURATION_SECONDS: '{{.TIMER_DURATION_SECONDS | default "300"}}'
      CONTROL_PLANE_ENDPOINT: '{{.CONTROL_PLANE_ENDPOINT | default "http://host.containers.internal:50053"}}'
    cmds:
      - podman run --rm -p 50051:50051
        -e TIMER_DURATION_SECONDS=$TIMER_DURATION_SECONDS
        -e CONTROL_PLANE_ENDPOINT=$CONTROL_PLANE_ENDPOINT
        -e RUST_LOG=info
        {{.SERVICE_NAME}}:{{.IMAGE_TAG}}

  container:push:
    desc: "Push timer container image"
    cmds:
      - podman tag {{.SERVICE_NAME}}:{{.IMAGE_TAG}} {{.REGISTRY}}/{{.SERVICE_NAME}}:{{.IMAGE_TAG}}
      - podman push {{.REGISTRY}}/{{.SERVICE_NAME}}:{{.IMAGE_TAG}}

  container:logs:
    desc: "Show container logs"
    cmds:
      - podman logs {{.SERVICE_NAME}}:{{.IMAGE_TAG}} || echo "Container not running"

  container:stop:
    desc: "Stop running timer container"
    cmds:
      - podman stop {{.SERVICE_NAME}} || echo "Container not running"

  # Kubernetes in Docker (using Podman)
  k8s:cluster:start:
    desc: "ğŸš€ Start local Kubernetes cluster with Podman"
    cmds:
      - |
        # Check if container exists (running or stopped)
        if podman ps -a --format "{{`{{.Names}}`}}" | grep -q "^kind-control-plane$"; then
          echo "Found existing kind-control-plane container..."
          # Check if it's running
          if podman ps --format "{{`{{.Names}}`}}" | grep -q "^kind-control-plane$"; then
            echo "âœ… Kubernetes cluster is already running"
            exit 0
          else
            echo "ğŸ”„ Starting existing container..."
            podman start kind-control-plane
            echo "âœ… Cluster restarted!"
            exit 0
          fi
        fi

        echo "ğŸš€ Starting new Kubernetes cluster with kind..."
        podman run -d --name kind-control-plane --privileged \
          -p 6443:6443 \
          --cgroupns=host -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
          kindest/node:v1.27.3

        echo "â³ Waiting for cluster to be ready..."
        sleep 30

        echo "âœ… Cluster started!"
        echo "ğŸ’¡ Configure kubectl with:"
        echo "   kubectl config set-cluster kind --server=https://127.0.0.1:6443 --insecure-skip-tls-verify=true"

  k8s:cluster:stop:
    desc: "ğŸ›‘ Stop local Kubernetes cluster"
    cmds:
      - |
        if podman ps -a --format "{{`{{.Names}}`}}" | grep -q "^kind-control-plane$"; then
          echo "ğŸ›‘ Stopping Kubernetes cluster..."
          podman stop kind-control-plane || echo "Already stopped"
          podman rm kind-control-plane || echo "Already removed"
          echo "âœ… Cluster stopped and removed"
        else
          echo "â„¹ï¸ No Kubernetes cluster found"
        fi

  k8s:cluster:status:
    desc: "ğŸ“Š Check Kubernetes cluster status"
    cmds:
      - |
        if podman ps --format "{{`{{.Names}}`}}" | grep -q "^kind-control-plane$"; then
          echo "âœ… Kubernetes cluster is running"
          echo "ğŸ” Checking cluster health..."
          if podman exec kind-control-plane kubectl get nodes --no-headers 2>/dev/null | grep -q "Ready"; then
            echo "âœ… Cluster is healthy and ready"
            podman exec kind-control-plane kubectl get nodes
          else
            echo "âš ï¸ Cluster is starting up or not ready yet"
          fi
        elif podman ps -a --format "{{`{{.Names}}`}}" | grep -q "^kind-control-plane$"; then
          echo "â¸ï¸ Kubernetes cluster container exists but is not running"
          echo "ğŸ’¡ Run 'task k8s:cluster:start' to start it"
        else
          echo "âŒ No Kubernetes cluster found"
          echo "ğŸ’¡ Run 'task k8s:cluster:start' to create one"
        fi

  k8s:cluster:shell:
    desc: "ğŸš Shell into Kubernetes cluster container"
    cmds:
      - |
        if podman ps --format "{{`{{.Names}}`}}" | grep -q "^kind-control-plane$"; then
          echo "ğŸš Opening shell in Kubernetes cluster..."
          podman exec -it kind-control-plane bash
        else
          echo "âŒ Kubernetes cluster is not running"
          echo "ğŸ’¡ Start it with: task k8s:cluster:start"
        fi

  k8s:cluster:reset:
    desc: "ğŸ”„ Reset Kubernetes cluster (stop, remove, and start fresh)"
    cmds:
      - task: k8s:cluster:stop
      - task: k8s:cluster:start

  k8s:cluster:load:
    desc: "ğŸ“¦ Load timer image into Kubernetes cluster"
    cmds:
      - |
        echo "Loading {{.SERVICE_NAME}}:{{.IMAGE_TAG}} into cluster..."
        podman save {{.SERVICE_NAME}}:{{.IMAGE_TAG}} | podman exec -i kind-control-plane ctr -n k8s.io images import -

  # Regular Kubernetes tasks
  k8s:apply:
    desc: "â˜¸ï¸ Apply timer Kubernetes resources"
    cmds:
      - kubectl apply -f k8s/

  k8s:delete:
    desc: "ğŸ—‘ï¸ Delete timer Kubernetes resources"
    cmds:
      - kubectl delete -f k8s/ --ignore-not-found=true

  k8s:logs:
    desc: "ğŸ“‹ Show timer logs in Kubernetes"
    cmds:
      - kubectl logs -l app=timer-service --tail=100 -f

  k8s:status:
    desc: "ğŸ“Š Show timer status in Kubernetes"
    cmds:
      - kubectl get jobs,pods -l app=timer-service

  # Deployment
  deploy:
    desc: "ğŸš€ Deploy timer (build + push + apply)"
    cmds:
      - task: container:build
      - task: container:push
      - task: k8s:apply

  deploy:local:
    desc: "ğŸ  Deploy timer to local Kubernetes cluster"
    cmds:
      - echo "ğŸ—ï¸ Building container image..."
      - task: container:build
      - echo "ğŸ“¦ Loading image into local cluster..."
      - task: k8s:cluster:load
      - echo "â˜¸ï¸ Applying Kubernetes resources..."
      - task: k8s:apply
      - echo "âœ… Local deployment complete!"

  deploy:dev:
    desc: "ğŸš€ Full development deployment (cluster + app)"
    cmds:
      - echo "ğŸš€ Starting local Kubernetes cluster..."
      - task: k8s:cluster:start
      - echo "ğŸ—ï¸ Building and deploying timer..."
      - task: deploy:local
      - echo "ğŸ“Š Checking deployment status..."
      - task: k8s:status

  deploy:script:
    desc: "ğŸš€ Deploy using deploy script"
    cmds:
      - ./scripts/deploy.sh

  # Health and monitoring
  health:
    desc: "Check timer health"
    cmds:
      - cargo run -- health

  # Cleanup
  clean:
    desc: "Clean timer build artifacts"
    cmds:
      - cargo clean
      - rm -rf target/

  logs:
    desc: "Show local timer logs"
    cmds:
      - tail -f /tmp/timer-service.log || echo "No log file found"

  # Development shortcuts
  dev:
    desc: "Quick development cycle"
    cmds:
      - task: check
      - task: run:debug
