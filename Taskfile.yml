# ctrlsys Root Taskfile

version: '3'

vars:
  PROJECT_NAME: ctrlsys

includes:
  timer:
    taskfile: ./jobs/timer/Taskfile.yml
    dir: ./jobs/timer
  api:
    taskfile: ./apps/api/Taskfile.yml
    dir: ./apps/api
  cli:
    taskfile: ./cli/Taskfile.yml
    dir: ./cli
  lib:
    taskfile: ./lib/Taskfile.yml
    dir: ./lib

tasks:
  # Default task - show available tasks
  default:
    desc: "ğŸ“‹ List all available tasks"
    cmds:
      - task --list-all
    silent: true

  # Project overview
  info:
    desc: "â„¹ï¸ Show project information"
    silent: true
    cmds:
      - echo "ğŸš€ {{.PROJECT_NAME}} - Control System Platform"
      - echo ""
      - echo "ğŸ“ Components:"
      - echo "  timer    - Timer microservice (jobs/timer/)"
      - echo "  api      - API service (apps/api/)"
      - echo "  cli      - CLI tool (cli/)"
      - echo "  lib      - Shared library (lib/)"
      - echo ""
      - echo "ğŸ”§ Quick commands:"
      - echo "  task timer:dev     - Timer development cycle"
      - echo "  task api:dev       - API development cycle"
      - echo "  task cli:dev       - CLI development cycle"
      - echo "  task lib:dev       - Library development cycle"
      - echo ""
      - echo "  task build:all     - Build all components"
      - echo "  task test:all      - Test all components"
      - echo "  task check:all     - Check all components"
      - echo ""
      - echo "ğŸ³ Container & Kubernetes:"
      - echo "  task k8s:cluster:start  - Start local K8s cluster"
      - echo "  task k8s:dev            - Full local K8s setup"
      - echo "  task timer:deploy:local - Deploy timer locally"
      - echo "  task container:build:all - Build all images"
      - echo ""
      - echo "ğŸ’¡ Use task <component>:<task> to run specific tasks"
      - echo "   Example - task timer:run or task timer:container:build"

  # Workspace-level tasks
  build:all:
    desc: "ğŸ—ï¸ Build all components"
    cmds:
      - echo "Building all components..."
      - cargo build --workspace

  build:release:
    desc: "ğŸ—ï¸ Build all components (release)"
    cmds:
      - echo "Building all components (release)..."
      - cargo build --workspace --release

  test:all:
    desc: "ğŸ§ª Test all components"
    cmds:
      - echo "Testing all components..."
      - cargo test --workspace

  fmt:all:
    desc: "ğŸ¨ Format all code"
    cmds:
      - cargo fmt --all

  clippy:all:
    desc: "ğŸ” Lint all code"
    cmds:
      - cargo clippy --workspace -- -D warnings

  check:all:
    desc: "âœ… Check all code (fmt + clippy + test)"
    cmds:
      - task: fmt:all
      - task: clippy:all
      - task: test:all

  # Development workflow
  dev:
    desc: "ğŸš€ Full development cycle"
    cmds:
      - task: check:all
      - echo "âœ… All components ready for development"

  # Container tasks
  container:build:all:
    desc: "ğŸ³ Build all container images"
    cmds:
      - task: timer:container:build
      - task: api:container:build

  # Kubernetes cluster management
  k8s:cluster:start:
    desc: "ğŸš€ Start local Kubernetes cluster"
    cmds:
      - task: timer:k8s:cluster:start

  k8s:cluster:stop:
    desc: "ğŸ›‘ Stop local Kubernetes cluster"
    cmds:
      - task: timer:k8s:cluster:stop

  k8s:cluster:status:
    desc: "ğŸ“Š Check Kubernetes cluster status"
    cmds:
      - task: timer:k8s:cluster:status

  # Kubernetes deployment tasks
  k8s:apply:
    desc: "â˜¸ï¸ Apply all Kubernetes resources"
    cmds:
      - task: timer:k8s:apply

  k8s:delete:
    desc: "ğŸ—‘ï¸ Delete Kubernetes resources"
    cmds:
      - task: timer:k8s:delete

  k8s:dev:
    desc: "ğŸš€ Full local Kubernetes development setup"
    cmds:
      - task: k8s:cluster:start
      - task: timer:deploy:local

  # Cleanup
  clean:all:
    desc: "ğŸ§¹ Clean all build artifacts"
    cmds:
      - cargo clean --workspace
      - rm -rf target/

  # Utilities
  watch:all:
    desc: "ğŸ‘€ Watch all components for changes"
    cmds:
      - cargo watch -x "build --workspace"

  # Quick aliases
  b:
    desc: "ğŸ—ï¸ Build all (alias)"
    cmds:
      - task: build:all

  t:
    desc: "ğŸ§ª Test all (alias)"
    cmds:
      - task: test:all

  c:
    desc: "âœ… Check all (alias)"
    cmds:
      - task: check:all