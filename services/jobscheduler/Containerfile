# Build stage
FROM golang:1.25-alpine AS builder

# Install build dependencies including Buf
RUN apk add --no-cache git curl && \
    # Install Buf (latest version)
    BUF_VERSION=1.57.2 && \
    curl -sSL "https://github.com/bufbuild/buf/releases/download/v${BUF_VERSION}/buf-$(uname -s)-$(uname -m)" -o "/usr/local/bin/buf" && \
    chmod +x "/usr/local/bin/buf"

# Set working directory to repository root
WORKDIR /app

# Copy root go.mod and go.sum for dependency resolution
COPY go.mod go.sum ./

# Copy buf configuration
COPY buf.yaml buf.gen.yaml ./

# Copy proto files
COPY proto/ ./proto/

# Generate protobuf code using Buf
RUN buf generate

# Copy jobscheduler specific files
COPY services/jobscheduler/ ./services/jobscheduler/
WORKDIR /app/services/jobscheduler

# Download jobscheduler dependencies
RUN go mod download

# Copy jobscheduler source code
COPY services/jobscheduler/ ./

# Set build args for version information
ARG VERSION=dev
ARG GIT_COMMIT=unknown
ARG BUILD_DATE=unknown
ARG GO_VERSION=unknown

# Build the application with version information
RUN CGO_ENABLED=0 GOOS=linux go build \
    -ldflags "-X github.com/t-eckert/ctrlsys/services/jobscheduler/internal/version.Version=${VERSION} \
    -X github.com/t-eckert/ctrlsys/services/jobscheduler/internal/version.GitCommit=${GIT_COMMIT} \
    -X github.com/t-eckert/ctrlsys/services/jobscheduler/internal/version.BuildDate=${BUILD_DATE} \
    -X github.com/t-eckert/ctrlsys/services/jobscheduler/internal/version.GoVersion=${GO_VERSION} \
    -s -w" \
    -a -installsuffix cgo -o jobscheduler .

# Runtime stage
FROM alpine:3.18

# Install ca-certificates for TLS
RUN apk --no-cache add ca-certificates tzdata

# Create non-root user
RUN adduser -D -s /bin/sh jobscheduler

# Set working directory
WORKDIR /app

# Copy the binary from builder stage
COPY --from=builder /app/services/jobscheduler/jobscheduler .

# Change ownership of the app directory
RUN chown -R jobscheduler:jobscheduler /app

# Switch to non-root user
USER jobscheduler

# Expose gRPC port
EXPOSE 50054

# Health check
HEALTHCHECK --interval=30s --timeout=5s --start-period=5s --retries=3 \
    CMD ./jobscheduler health || exit 1

# Default command
CMD ["./jobscheduler"]
